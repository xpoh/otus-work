# Домашнее задание

1. В качестве решения используется кластер Clickhouse с двумя шардами без репликации
2. Кластер поднимается отдельным docker-compose файлом в директории `./clickhouse_cluster` 
3. Взаимодействие с кластеров осуществляется через балансировщик нагрузки `ch-proxy`
4. В качестве ключа шардирования выбрана сумма первых байт ID пользователя отправителя и получателя, таким образом 
даже если существует массовая широковещательная рассылка от одного пользователя, она тоже будет шардирована (нет эффекта леди Гаги)
5. Ключ шардирования выбран в качестве `PRIMARY KEY` таким образом при чтении диалогов оно будет происходить с одного шарда
6. Процесс решардинга будет происходить так:
    - При увеличении количества шардов:
      - поднимается новый сервер Clickhouse, прописывается в конфиге кластера, делается релоад конфиг
      - Меняется енвиронка для сервиса `SHARDS_COUNT`
      - делается релоад конфига (отдельная ручка, которая не реализована, но если надо то будет)
      - данные начинают идти на новый шард
      - вручную делается SQL запрос, чтобы перераспределить данные по шардам (все будет работать и без этого, но это 
      повысит производительность чтения)
    - При уменьшении количества шардов:
      - Меняется енвиронка для сервиса `SHARDS_COUNT`
      - делается релоад конфига (отдельная ручка, которая не реализована, но если надо то будет)
      - данные перестают поступать на шард, но запросы на чтение работают (в запросах есть дедупликация сообщений)
      - вручную делается SQL запрос, чтобы перенести данные на оставшиеся шарды
      - сервер Clickhouse выводится из эксплуатации, прописывается в конфиге кластера, делается релоад конфиг
